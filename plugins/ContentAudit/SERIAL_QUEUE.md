# 串行审核队列说明

## 设计目标

1. **串行执行**：审核任务按顺序执行，一个接一个
2. **API 不可用时暂停**：如果 API 超时或不可用，后续任务不执行，等待 API 恢复
3. **自动恢复**：API 恢复后，任务自动继续执行

## 实现方式

### 1. 专用队列

审核任务使用专用队列 `audit`，确保与其他任务隔离：

```php
->onQueue('audit')
```

### 2. 队列锁机制

使用缓存锁确保同一时间只有一个审核任务在执行：

```php
$lock = cache()->lock('audit:api:lock', 300);
```

- 如果无法获取锁，任务延迟 10 秒后重试
- 任务完成后自动释放锁

### 3. API 健康检查

在任务执行前检查 API 是否可用：

- 如果 API 最近标记为不可用（5 分钟内），直接延迟任务
- 避免无效的 API 调用

### 4. API 不可用标记

当 API 连接失败时，标记 API 为不可用：

- 标记有效期：5 分钟
- 5 分钟后自动清除，允许再次尝试

## 启动队列处理器

**重要**：必须使用专用队列名称启动队列处理器，确保串行执行：

```bash
# Docker 环境
docker-compose -f deploy/docker-compose.yml exec app php artisan queue:work --queue=audit --sleep=3 --tries=10

# 或者只处理 audit 队列（推荐，确保串行执行）
docker-compose -f deploy/docker-compose.yml exec app php artisan queue:work --queue=audit
```

**关键点**：
- 使用 `--queue=audit` 只处理审核队列
- 不要同时启动多个队列处理器处理 audit 队列（否则会并发执行）
- 如果需要处理其他队列，可以启动另一个队列处理器：`--queue=default`

## 工作流程

### 正常情况：
```
任务1 → 获取锁 → 检查 API → 执行审核 → 释放锁
任务2 → 获取锁 → 检查 API → 执行审核 → 释放锁
任务3 → 获取锁 → 检查 API → 执行审核 → 释放锁
```

### API 不可用：
```
任务1 → 获取锁 → 检查 API（不可用）→ 延迟 60 秒 → 释放锁
任务2 → 等待锁 → 无法获取 → 延迟 10 秒
任务3 → 等待锁 → 无法获取 → 延迟 10 秒
...
（60 秒后）
任务1 → 重试 → 检查 API（仍不可用）→ 延迟 60 秒
...
（API 恢复后）
任务1 → 重试 → 检查 API（可用）→ 执行审核 → 释放锁
任务2 → 获取锁 → 执行审核 → 释放锁
```

## 优势

✅ **串行执行**：确保审核任务按顺序执行  
✅ **智能暂停**：API 不可用时自动暂停，不浪费资源  
✅ **自动恢复**：API 恢复后自动继续  
✅ **资源保护**：避免同时发起大量 API 请求

## 注意事项

**必须使用专用队列**：启动队列处理器时必须指定 `--queue=audit`  
**锁超时**：锁超时时间为 5 分钟，如果任务执行超过 5 分钟，锁会自动释放  
**API 标记**：API 不可用标记有效期为 5 分钟，之后会自动清除

