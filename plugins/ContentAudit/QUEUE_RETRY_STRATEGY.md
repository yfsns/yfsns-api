# 队列重试策略说明

## 当前配置

### 重试次数
- **重试次数**: 10 次
- **超时时间**: 120 秒

### 重试延迟（指数退避）
- 第 1 次重试：等待 60 秒
- 第 2 次重试：等待 120 秒（2分钟）
- 第 3 次重试：等待 240 秒（4分钟）
- 第 4 次重试：等待 480 秒（8分钟）
- 第 5 次重试：等待 960 秒（16分钟）
- 第 6-10 次：使用最后一次延迟（16分钟）

## 工作流程

### 1. 任务执行失败
```
用户发布内容
  ↓
任务加入队列
  ↓
队列处理器执行任务
  ↓
调用审核 API（失败，抛出异常）
  ↓
任务标记为失败，等待重试
```

### 2. 自动重试
```
第 1 次失败 → 等待 60 秒 → 重试
第 2 次失败 → 等待 120 秒 → 重试
第 3 次失败 → 等待 240 秒 → 重试
...
第 10 次失败 → 进入失败队列
```

### 3. 最终失败处理
- 如果 10 次重试都失败，任务会进入 `failed_jobs` 表
- 在 `failed()` 方法中记录错误日志
- 管理员可以手动重试：`php artisan queue:retry {id}`

## 优势

✅ **自动重试**：API 暂时不可用时，任务会自动重试  
✅ **延迟重试**：避免频繁请求，给 API 恢复时间  
✅ **指数退避**：重试间隔逐渐增加，减少系统负载  
✅ **可恢复**：失败的任务可以手动重试

## 手动重试失败任务

```bash
# 查看失败任务
php artisan queue:failed

# 重试所有失败任务
php artisan queue:retry all

# 重试指定任务
php artisan queue:retry {id}

# 删除失败任务
php artisan queue:forget {id}
```

## 如果需要更长的重试时间

如果希望任务保留更长时间等待 API 恢复，可以：

1. **增加重试次数**：修改 `$tries = 20` 或更多
2. **增加重试延迟**：修改 `$backoff` 数组，例如 `[300, 600, 1800, 3600]`（5分钟、10分钟、30分钟、1小时）
3. **使用延迟队列**：失败后延迟更长时间再重试

## 注意事项

**队列处理器必须运行**：如果队列处理器停止，任务不会自动重试  
**任务会占用队列**：失败的任务会保留在队列中，直到重试完成或进入失败队列  
**数据库队列限制**：使用 database 驱动时，失败的任务会保留在 `jobs` 表中

