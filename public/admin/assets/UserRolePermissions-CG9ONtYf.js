import{i as I,j as s}from"./index-C42INjwk.js";import{f as J,j as U,r}from"./react-vendor-CKx6dMfn.js";import{a as P}from"./userApi-DWgK7BFN.js";import{F as g,h as W,i as T,S as b,B as D,H as O,J as Q,K as X,I as Y,q as Z,N as ee,m as se,s as u,u as E}from"./antd-vendor-DaJANQRB.js";import"./redux-vendor-DakFfX2h.js";const te={getTree:async()=>(await I.get("/api/admin/permissions/tree")).data||[],fetchList:async(o={})=>{const i={page:o.page||1,per_page:o.per_page||10,module:o.module,keyword:o.keyword},l=(await I.get("/api/admin/permissions",{params:i})).data;return{data:l.list||[],total:l.total||0,current_page:l.page||1,per_page:l.perPage||10,last_page:l.lastPage||1}}},{Search:ae}=Y,ce=()=>{const o=J(),{id:i}=U(),[c]=g.useForm(),[l,x]=r.useState(!1),[R,y]=r.useState(!1),[j,A]=r.useState(null),[p,B]=r.useState([]),[S,w]=r.useState([]),[F,h]=r.useState([]),[v,K]=r.useState(""),f=i&&i!=="new",_=async()=>{var a,t;try{const e=await te.getTree();B(e);const n=e.map(d=>d.module);h(n)}catch(e){u.error(((t=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:t.message)||"加载权限树失败")}},z=a=>{let t=[];return a.forEach(e=>{t.push(e.module),e.permissions.forEach(n=>{t.push(n.slug)})}),t},G=async a=>{var t,e;x(!0);try{const n=await P.getDetail(a);A(n),n.permissions&&n.permissions.length>0&&(w(n.permissions),c.setFieldsValue({permissions:n.permissions}))}catch(n){u.error(((e=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:e.message)||"加载角色数据失败")}finally{x(!1)}};r.useEffect(()=>{_(),f&&i?G(i):c.setFieldsValue({permissions:[]})},[i,f]);const M=a=>a.map(t=>({title:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("span",{style:{fontWeight:"bold",fontSize:"14px"},children:t.module}),s.jsxs(E,{color:"blue",style:{marginLeft:8},children:[t.permissions.length," 个权限"]})]}),key:t.module,children:t.permissions.map(e=>({title:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[s.jsx("span",{children:e.name}),e.description&&s.jsxs("span",{style:{color:"#999",fontSize:"12px",marginLeft:8},children:["(",e.description,")"]}),s.jsx(E,{color:"default",style:{marginLeft:8,fontSize:"11px"},children:e.slug})]}),key:e.slug}))})),k=(a,t)=>{if(!t)return a;const e=t.toLowerCase();return a.map(n=>{const d=n.permissions.filter(m=>{var L;return m.name.toLowerCase().includes(e)||m.slug.toLowerCase().includes(e)||((L=m.description)==null?void 0:L.toLowerCase().includes(e))||n.module.toLowerCase().includes(e)});return n.module.toLowerCase().includes(e)||d.length>0?{...n,permissions:d}:null}).filter(n=>n!==null)},q=a=>{const e=(Array.isArray(a)?a:a.checked).filter(n=>p.some(d=>d.permissions.some(m=>m.slug===n)));w(e),c.setFieldsValue({permissions:e})},C=a=>{if(K(a),a){const t=k(p,a),e=z(t);h(e)}else{const t=p.map(e=>e.module);h(t)}},$=async()=>{var a,t;try{const e=await c.validateFields();if(!f||!i){u.error("角色ID不存在");return}y(!0),await P.updatePermissions(i,e.permissions||[]),u.success("权限设置保存成功")}catch(e){const n=((t=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"保存失败";u.error(n)}finally{y(!1)}},H=()=>{o("/user/role")},N=v?k(p,v):p,V=M(N);return l?s.jsx("div",{style:{textAlign:"center",padding:"50px"},children:s.jsx(W,{size:"large"})}):s.jsxs("div",{children:[s.jsx(T,{style:{marginBottom:16},children:s.jsxs(b,{children:[s.jsx(D,{icon:s.jsx(O,{}),onClick:H,children:"返回"}),s.jsx(Q,{type:"vertical"}),s.jsx("h2",{style:{margin:0},children:j?`${j.name} - 权限配置`:"权限配置"})]})}),s.jsxs(T,{title:s.jsxs(b,{children:[s.jsx(se,{}),s.jsx("span",{children:"权限配置"})]}),style:{marginBottom:16},children:[s.jsx(X,{message:"权限配置说明",description:"选择该角色拥有的权限点。权限点以 slug 形式存储（如 post.view、post.text），提交后角色将获得对应的能力。管理员账号 (is_admin=true) 自动拥有全部权限。",type:"info",showIcon:!0,style:{marginBottom:16}}),s.jsx(g,{form:c,layout:"vertical",children:s.jsx(g.Item,{name:"permissions",label:"权限选择",rules:[{required:!1}],children:s.jsxs("div",{children:[s.jsx(ae,{placeholder:"搜索权限名称、slug、描述或模块",allowClear:!0,onSearch:C,onChange:a=>C(a.target.value),style:{marginBottom:16},prefix:s.jsx(Z,{})}),s.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:4,padding:16,maxHeight:600,overflow:"auto"},children:s.jsx(ee,{checkable:!0,checkedKeys:S,onCheck:q,treeData:V,expandedKeys:F,onExpand:h,defaultExpandAll:!1,checkStrictly:!1,selectable:!1})}),s.jsxs("div",{style:{marginTop:16,color:"#666",fontSize:"14px"},children:["已选择 ",s.jsx("strong",{style:{color:"#1890ff"},children:S.length})," 个权限点"]})]})})})]}),s.jsx("div",{style:{display:"flex",justifyContent:"flex-start",padding:"12px 0",borderTop:"1px solid #f0f0f0",marginTop:"16px"},children:s.jsx(D,{type:"primary",onClick:$,loading:R,children:"保存"})})]})};export{ce as default};
