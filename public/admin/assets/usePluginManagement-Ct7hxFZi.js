import{r as l}from"./react-vendor-CKx6dMfn.js";import{s as w}from"./index-CPCCNLS5.js";import{i as p}from"./index-C42INjwk.js";import{s as m}from"./antd-vendor-DaJANQRB.js";const h={fetchList:async e=>({success:!0,data:(await p.get("/api/admin/plugins",{params:e})).data}),installPlugin:async e=>(await p.post(`/api/admin/plugins/${e}/install`)).data,enablePlugin:async e=>(await p.post(`/api/admin/plugins/${e}/enable`)).data,disablePlugin:async e=>(await p.post(`/api/admin/plugins/${e}/disable`)).data,getPluginConfig:async e=>{const n=await p.get(`/api/admin/plugins/${e}/config`);return{pluginName:e,configGroups:n.data||[]}},updatePluginConfig:async(e,n)=>(await p.put(`/api/admin/plugins/${e}/config`,n)).data,getPluginDetail:async e=>{const n=await p.get(`/api/admin/plugins/${e}`);return{success:n.data.code===200,data:n.data.data}},resetPluginConfig:async e=>(await p.post(`/api/admin/plugins/${e}/config/reset`)).data,uninstallPlugin:async e=>(await p.delete(`/api/admin/plugins/${e}`)).data,getDataTableData:async(e,n,o={})=>(await p.get(`/api/admin/plugins/${e}/config/data-tables/${n}`,{params:o})).data,executeButtonAction:async(e,n)=>(await p.post(`/api/admin/plugins/${e}/config/actions`,n)).data,updateDataTableRecord:async(e,n,o,c)=>(await p.patch(`/api/admin/plugins/${e}/config/data-tables/${n}/records/${o}`,c)).data,deleteDataTableRecord:async(e,n,o)=>(await p.delete(`/api/admin/plugins/${e}/config/data-tables/${n}/records/${o}`)).data,batchOperateDataTableRecords:async(e,n,o,c)=>(await p.post(`/api/admin/plugins/${e}/config/data-tables/${n}/batch/${o}`,c)).data},L=e=>{let n="not_installed",o="inactive";return e.installed===!0?e.enabled===!0||e.status==="enabled"?(n="installed_enabled",o="active"):(n="installed_disabled",o="inactive"):e.installed===!1?(n="not_installed",o="inactive"):e.installStatus&&(n=e.installStatus,n==="installed_enabled"?o="active":n==="installed_disabled"&&(o="inactive")),{id:String(e.id||e.name),name:e.name,description:e.description||"",version:e.version||"",author:e.author||"",status:o,installStatus:n,installed:e.installed||!1,hasConfig:e.hasConfig||!1,dependencies:e.dependencies||[],lastUpdated:e.updatedAt||e.createdAt||"",database:e.database,type:void 0,category:void 0,downloads:void 0,rating:void 0}},T=()=>{const[e,n]=l.useState([]),[o,c]=l.useState(!1),d=l.useCallback(async()=>{c(!0);try{const i=await h.fetchList({});let s=[];Array.isArray(i)?s=i:i&&typeof i=="object"&&(i.success!==void 0&&i.data?s=i.data:s=i.list||i.data||[]);const r=Array.isArray(s)?s.map(L):[];n(r)}catch(i){console.error("Error fetching plugins:",i),w("获取插件列表失败"),n([])}finally{c(!1)}},[]),f=l.useCallback(async i=>{var s,r;c(!0);try{const a=e.find(t=>t.id===i);if(!a){w("插件不存在");return}a.status==="active"?(await h.disablePlugin(a.name),m.success("插件已禁用")):(await h.enablePlugin(a.name),m.success("插件已启用")),await d()}catch(a){w(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.message)||"操作失败")}finally{c(!1)}},[e,d]),$=l.useCallback(async i=>{var r,a;const s=e.find(t=>t.id===i);if(!s){w("插件不存在");return}if(s.status==="installing"){m.warning("插件正在安装中，请勿重复操作");return}if(s.installStatus==="installed_enabled"||s.installStatus==="installed_disabled"){m.warning("插件已安装，无需重复安装");return}c(!0);try{n(y=>y.map(u=>u.id===i?{...u,status:"installing"}:u));const t=await h.installPlugin(s.name);if(m.success(t.message||"插件安装成功"),t.data){const y=L(t.data);n(u=>u.map(g=>g.id===i?y:g))}await d()}catch(t){n(u=>u.map(g=>g.id===i?{...g,status:"error"}:g));const y=((a=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:a.message)||(t==null?void 0:t.message)||"插件安装失败";w(y)}finally{c(!1)}},[e,d]),b=l.useCallback(async i=>{var s,r;try{return(await h.getPluginDetail(i)).data}catch(a){return w(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.message)||"获取插件详情失败"),null}},[]),S=l.useCallback(async i=>{var s,r;c(!0);try{await h.resetPluginConfig(i),m.success("插件配置已重置"),await d()}catch(a){w(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.message)||"重置配置失败")}finally{c(!1)}},[d]),P=l.useCallback(async i=>{var s,r;c(!0);try{await h.uninstallPlugin(i),m.success("插件卸载成功"),await d()}catch(a){w(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.message)||"卸载失败")}finally{c(!1)}},[d]),v=l.useCallback(()=>({total:e.length,active:e.filter(s=>s.status==="active").length,inactive:e.filter(s=>s.status==="inactive").length,installing:e.filter(s=>s.status==="installing").length,error:e.filter(s=>s.status==="error").length,categories:[...new Set(e.map(s=>s.category).filter(Boolean))].length}),[e]),C=l.useCallback(i=>e.filter(s=>s.category===i||!i&&!s.category),[e]),k=l.useCallback(i=>e.filter(s=>s.status===i),[e]),E=l.useCallback(i=>{if(!i)return e;const s=i.toLowerCase();return e.filter(r=>r.name.toLowerCase().includes(s)||r.description.toLowerCase().includes(s)||r.category&&r.category.toLowerCase().includes(s)||r.author.toLowerCase().includes(s))},[e]);return l.useEffect(()=>{d()},[d]),{pluginList:e,loading:o,fetchPlugins:d,handleTogglePlugin:f,handleInstallPlugin:$,uninstallPlugin:P,getPluginDetail:b,resetPluginConfig:S,getPluginStats:v,getPluginsByCategory:C,getPluginsByStatus:k,searchPlugins:E}},V=e=>{const[n,o]=l.useState(!1),[c,d]=l.useState(!1),[f,$]=l.useState(null),[b,S]=l.useState({}),[P,v]=l.useState({}),C=l.useCallback(async()=>{var s,r;if(e){o(!0);try{const a=await h.getPluginConfig(e),t={hasConfig:a.configGroups.length>0,schema:void 0,values:{},groups:a.configGroups.map(u=>({key:u.name,label:u.label,configs:u.configItems}))};$(t);const y={};a.configGroups.forEach(u=>{u.configItems.forEach(g=>{const A=g.value!==void 0?g.value:g.defaultValue;y[g.key]=A})}),S(y)}catch(a){const t=((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.message)||(a==null?void 0:a.message)||"获取插件配置失败";m.error(t),$(null)}finally{o(!1)}}},[e]),k=l.useCallback(async()=>{var r,a;if(!e||!f)return!1;const s={};if(f.groups.forEach(t=>{var y;(y=t.configs)==null||y.forEach(u=>{const g=b[u.key];u.required&&(g==null||g==="")&&(s[u.key]=`${u.label}不能为空`)})}),Object.keys(s).length>0)return v(s),m.error("请填写所有必填字段"),!1;v({}),d(!0);try{const t=await h.updatePluginConfig(e,b);return t.code===200?(m.success("配置保存成功"),v({}),await C(),!0):(m.error(t.message||"保存失败"),!1)}catch(t){const y=((a=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:a.message)||(t==null?void 0:t.message)||"保存失败";return m.error(y),!1}finally{d(!1)}},[e,f,b,C]),E=l.useCallback((s,r)=>{S(a=>({...a,[s]:r})),P[s]&&v(a=>{const t={...a};return delete t[s],t})},[P]),i=l.useMemo(()=>{if(!(f!=null&&f.values))return!1;try{const s=Object.keys(f.values).sort().reduce((a,t)=>(a[t]=f.values[t],a),{}),r=Object.keys(b).sort().reduce((a,t)=>(a[t]=b[t],a),{});return JSON.stringify(s)!==JSON.stringify(r)}catch{return!1}},[b,f==null?void 0:f.values]);return l.useEffect(()=>{C()},[C]),{loading:n,saving:c,configData:f,formValues:b,errors:P,hasChanges:i,saveConfig:k,updateFormValue:E,refetch:C}};export{V as a,h as p,T as u};
