import{j as e}from"./index-C42INjwk.js";import{r as a,f as Y}from"./react-vendor-CKx6dMfn.js";import{a as D}from"./userApi-DWgK7BFN.js";import{s as c,F as w,S as K,B as y,y as Z,P as _,z as N,r,u as x,w as ee,E as te,v as se,x as ae,I as H,G as ne,o as X}from"./antd-vendor-DaJANQRB.js";import{L as le,S as ie,D as re}from"./ListPageLayout-DbaJDf8x.js";import"./redux-vendor-DakFfX2h.js";const ce=()=>{const[v,b]=a.useState(!1),[z,E]=a.useState([]),[g,L]=a.useState(0),o=a.useCallback(async(t={})=>{var s,l;b(!0);try{const n=await D.fetchList(t);E(n.list||[]),L(n.total||0)}catch(n){c.error(((l=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:l.message)||"获取数据失败"),E([]),L(0)}finally{b(!1)}},[]),[F,d]=a.useState(!1),[m,T]=a.useState(!1),[f,I]=a.useState(!1),[P,j]=a.useState(!1),[k,u]=a.useState(null),[p,h]=a.useState(!1),M=a.useCallback(async t=>{var s,l;d(!0);try{await D.delete(t),c.success("删除成功"),await o()}catch(n){c.error(((l=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:l.message)||"删除失败")}finally{d(!1)}},[o]),B=a.useCallback(async t=>{var s,l;if(!t||t.length===0){c.warning("请选择要删除的记录");return}T(!0);try{await D.batchDelete(t),c.success("批量删除成功"),await o()}catch(n){c.error(((l=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:l.message)||"批量删除失败")}finally{T(!1)}},[o]),A=a.useCallback(t=>{t?(u(t),h(!0)):(u(null),h(!1)),j(!0)},[]),S=a.useCallback(()=>{j(!1),u(null),h(!1)},[]),V=a.useCallback(async t=>{var s,l,n,q,J,G,Q;I(!0);try{p&&k?(await D.update(k.id,t),c.success("更新成功")):(await D.create(t),c.success("创建成功")),S(),await o()}catch(i){let R=(l=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:l.message;const C=((J=(q=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:q.data)==null?void 0:J.errors)||((Q=(G=i==null?void 0:i.response)==null?void 0:G.data)==null?void 0:Q.errors);if(C){const $=[];Object.keys(C).forEach(O=>{Array.isArray(C[O])?$.push(...C[O]):$.push(C[O])}),R=$.join("; ")||R||JSON.stringify(C)}R=R||(i==null?void 0:i.message)||(p?"更新失败":"创建失败"),c.error(R)}finally{I(!1)}},[p,k,o,S]);return{loading:v||F||m||f,userRoles:z,total:g,editModalVisible:P,editingRecord:k,isEditing:p,fetchData:o,handleDelete:M,handleBatchDelete:B,handleEdit:A,handleCloseModal:S,handleSubmit:V}},{Option:W}=X,me=()=>{const v=Y(),{loading:b,userRoles:z,total:E,fetchData:g,handleDelete:L,handleBatchDelete:o,handleSubmit:F}=ce(),[d]=w.useForm(),[m,T]=a.useState({current:1,pageSize:10}),[f,I]=a.useState([]),[P,j]=a.useState(!1),[k,u]=a.useState(null),[p,h]=a.useState(!1);a.useEffect(()=>{g({page:1,pageSize:10})},[g]);const M=()=>{d.resetFields(),u(null),h(!1),j(!0)},B=t=>{d.setFieldsValue(t),u(t),h(!0),j(!0)},A=t=>{v(`/user/role/permissions/${t.id}`)},S=()=>{j(!1),u(null),h(!1),d.resetFields()},V=async()=>{try{const t=await d.validateFields();await F(t),S(),g({page:m.current,pageSize:m.pageSize})}catch{}},U=()=>{if(f.length===0){c.warning("请选择要删除的记录");return}o(f),I([])};return e.jsxs(e.Fragment,{children:[e.jsxs(le,{children:[e.jsx(ie,{children:e.jsxs(K,{children:[e.jsx(y,{type:"primary",icon:e.jsx(Z,{}),onClick:M,children:"新增角色"}),e.jsx(_,{title:"确定要删除选中的记录吗？",onConfirm:U,okText:"确定",cancelText:"取消",children:e.jsx(y,{danger:!0,icon:e.jsx(N,{}),disabled:f.length===0,children:"批量删除"})})]})}),e.jsx(re,{children:e.jsxs(r,{dataSource:z,loading:b,rowKey:"id",pagination:{current:m.current,pageSize:m.pageSize,total:E,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,onChange:(t,s)=>{T({current:t,pageSize:s||10}),g({page:t,pageSize:s||10})}},rowSelection:{selectedRowKeys:f,onChange:I},children:[e.jsx(r.Column,{title:"ID",dataIndex:"id",width:80}),e.jsx(r.Column,{title:"角色名称",dataIndex:"name",width:150,render:(t,s)=>e.jsxs(K,{size:4,children:[e.jsx("span",{children:t}),s.isDefault&&e.jsx(x,{color:"gold",style:{margin:0},children:"默认"})]})}),e.jsx(r.Column,{title:"描述",dataIndex:"description",width:200,render:t=>t||"-"}),e.jsx(r.Column,{title:"类型",dataIndex:"isSystemPresetText",width:100,render:(t,s)=>e.jsx(x,{color:s.isSystemPreset?"purple":"cyan",children:s.isSystemPresetText})}),e.jsx(r.Column,{title:"权限",dataIndex:"permissions",width:200,render:t=>!t||t.length===0?"无权限":t.includes("*")?e.jsx(x,{color:"blue",children:"所有权限"}):t.slice(0,2).map(s=>e.jsx(x,{color:"green",children:s},s)).concat(t.length>2?[e.jsxs(x,{children:["+",t.length-2]},"more")]:[])}),e.jsx(r.Column,{title:"用户数量",dataIndex:"userCount",width:100,render:t=>{const s=t||0;return e.jsx(x,{color:s>0?"green":"default",children:s})}}),e.jsx(r.Column,{title:"状态",dataIndex:"status",width:100,render:(t,s)=>{const l=typeof t=="number"&&t===1||t==="active"?"green":"default";return e.jsx(x,{color:l,children:s.statusText})}}),e.jsx(r.Column,{title:"创建时间",dataIndex:"createdAt",width:160,render:t=>t||"-"}),e.jsx(r.Column,{title:"操作",width:200,render:(t,s)=>e.jsxs(K,{size:"small",children:[e.jsx(y,{type:"link",icon:e.jsx(ee,{}),onClick:()=>B(s),children:"编辑"}),e.jsx(y,{type:"link",icon:e.jsx(te,{}),onClick:()=>A(s),children:"权限"}),s.canDelete===!1?e.jsx(se,{title:s.canDeleteText,children:e.jsx(y,{type:"link",danger:!0,icon:e.jsx(N,{}),disabled:!0,children:"删除"})}):e.jsx(_,{title:"确定要删除这个角色吗？",onConfirm:()=>L(s.id),okText:"确定",cancelText:"取消",children:e.jsx(y,{type:"link",danger:!0,icon:e.jsx(N,{}),children:"删除"})})]})})]})})]}),e.jsx(ae,{title:p?"编辑角色基本信息":"新增角色",open:P,onCancel:S,onOk:V,confirmLoading:b,width:500,children:e.jsxs(w,{form:d,layout:"vertical",initialValues:{status:"active",isPaidRole:!1},children:[e.jsx(w.Item,{name:"name",label:"角色名称",rules:[{required:!0,message:"请输入角色名称"},{min:2,max:50,message:"角色名称长度为2-50个字符"}],children:e.jsx(H,{placeholder:"请输入角色名称"})}),e.jsx(w.Item,{name:"description",label:"角色描述",rules:[{max:200,message:"描述最多200个字符"}],children:e.jsx(H.TextArea,{placeholder:"请输入角色描述",rows:4,showCount:!0,maxLength:200})}),e.jsx(w.Item,{name:"isPaidRole",label:"是否付费角色",valuePropName:"checked",children:e.jsx(ne,{checkedChildren:"付费角色",unCheckedChildren:"普通角色"})}),e.jsx(w.Item,{name:"status",label:"状态",rules:[{required:!0,message:"请选择状态"}],children:e.jsxs(X,{placeholder:"请选择状态",children:[e.jsx(W,{value:"active",children:"启用"}),e.jsx(W,{value:"inactive",children:"禁用"})]})})]})})]})};export{me as default};
