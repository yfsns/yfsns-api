import{a as pe,j as e}from"./index-C42INjwk.js";import{r as a}from"./react-vendor-CKx6dMfn.js";import{u as R,a as re}from"./userApi-DWgK7BFN.js";import{s as x,F as c,I as B,o as q,p as ge,S as te,B as O,q as je,r as j,u as ae,T as fe,v as le,w as we,j as Se,a as ye,x as oe}from"./antd-vendor-DaJANQRB.js";import{L as be,S as Ce,D as ke}from"./ListPageLayout-DbaJDf8x.js";import"./redux-vendor-DakFfX2h.js";const ve=()=>{const[h,g]=a.useState(!1),[D,U]=a.useState([]),[J,E]=a.useState(0),[V,b]=a.useState([]),[N,$]=a.useState(!1),m=a.useCallback(async(l={})=>{var u,o;g(!0);try{const n=await R.fetchList(l);U(n.list||[]),E(n.total||0)}catch(n){x.error(((o=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:o.message)||"获取数据失败"),U([]),E(0)}finally{g(!1)}},[]),_=a.useCallback(async()=>{if(!(V.length>0)){$(!0);try{const l=await re.fetchList({page:1,pageSize:100});b(l.list||[])}catch(l){console.error("获取角色列表失败:",l),b([])}finally{$(!1)}}},[V.length]),[P,X]=a.useState(!1),[K,Y]=a.useState(!1),[Q,C]=a.useState(!1),[z,M]=a.useState(!1),[p,k]=a.useState(null),[F,A]=a.useState(!1),G=a.useCallback(async l=>{var u,o;X(!0);try{await R.delete(l),x.success("删除成功"),await m()}catch(n){x.error(((o=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:o.message)||"删除失败")}finally{X(!1)}},[m]),H=a.useCallback(async l=>{var u,o;if(!l||l.length===0){x.warning("请选择要删除的记录");return}Y(!0);try{await R.batchDelete(l),x.success("批量删除成功"),await m()}catch(n){x.error(((o=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:o.message)||"批量删除失败")}finally{Y(!1)}},[m]),W=a.useCallback(l=>{l?(k(l),A(!0)):(k(null),A(!1)),M(!0)},[]),s=a.useCallback(()=>{M(!1),k(null),A(!1)},[]),t=a.useCallback(async l=>{var u,o,n,S,y,r,I;C(!0);try{F&&p?(await R.update(p.id,l),x.success("更新成功")):(await R.create(l),x.success("创建成功")),s(),await m()}catch(i){let L=(o=(u=i==null?void 0:i.response)==null?void 0:u.data)==null?void 0:o.message;const T=((y=(S=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:S.data)==null?void 0:y.errors)||((I=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:I.errors);if(T){const ee=[];Object.keys(T).forEach(se=>{Array.isArray(T[se])?ee.push(...T[se]):ee.push(T[se])}),L=ee.join("; ")||L||JSON.stringify(T)}L=L||(i==null?void 0:i.message)||(F?"更新失败":"创建失败"),x.error(L)}finally{C(!1)}},[F,p,m,s]),[d,w]=a.useState(!1),[v,Z]=a.useState(null),[ce,ne]=a.useState(!1),de=a.useCallback(l=>{Z(l),w(!0)},[]),ue=a.useCallback(()=>{w(!1),Z(null)},[]),he=a.useCallback(async l=>{var u,o,n,S,y;if(v){ne(!0);try{await R.resetPassword(v.id,l),x.success("密码重置成功"),w(!1),Z(null),await m()}catch(r){const I=((o=(u=r==null?void 0:r.response)==null?void 0:u.data)==null?void 0:o.message)||((y=(S=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:S.data)==null?void 0:y.message)||(r==null?void 0:r.message)||"重置密码失败";x.error(I),console.error("重置密码失败:",r)}finally{ne(!1)}}},[v,m]),[me,ie]=a.useState(!1),xe=a.useCallback(async l=>{var n,S,y,r,I;const o=(typeof l.status=="number"?l.status:l.status==="active"?1:0)===1?0:1;ie(!0);try{await R.updateStatus(l.id,o),x.success(o===1?"用户已启用":"用户已禁用"),await m()}catch(i){const L=((S=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:S.message)||((I=(r=(y=i==null?void 0:i.response)==null?void 0:y.data)==null?void 0:r.data)==null?void 0:I.message)||(i==null?void 0:i.message)||"状态更新失败";x.error(L),console.error("状态更新失败:",i)}finally{ie(!1)}},[m]);return{loading:h||P||K||Q||ce||me||N,users:D,total:J,roles:V,editModalVisible:z,editingRecord:p,isEditing:F,fetchData:m,fetchRoles:_,handleDelete:G,handleBatchDelete:H,handleEdit:W,handleCloseModal:s,handleSubmit:t,resetPasswordModalVisible:d,resettingUser:v,handleResetPassword:de,handleCloseResetPasswordModal:ue,handleResetPasswordSubmit:he,handleToggleStatus:xe}},Ie=(h,g)=>({scroll:{x:g.isMobile?h.mobileScrollX||h.scrollX||"max-content":h.scrollX||"max-content",y:g.isMobile?h.mobileScrollY||h.scrollY||500:h.scrollY||500},size:g.isMobile?h.mobileSize||"small":h.size||"middle"}),{Option:f}=q,{RangePicker:Le}=ge,Ee=()=>{const h=pe(),{isMobile:g}=h,{loading:D,users:U,total:J,roles:E,editModalVisible:V,fetchData:b,handleEdit:N,handleCloseModal:$,handleSubmit:m,resetPasswordModalVisible:_,resettingUser:P,handleResetPassword:X,handleCloseResetPasswordModal:K,handleResetPasswordSubmit:Y,handleToggleStatus:Q}=ve(),[C]=c.useForm(),[z]=c.useForm(),[M]=c.useForm(),[p,k]=a.useState({current:1,pageSize:10}),F=E.map(s=>({label:s.name,value:s.id}));a.useEffect(()=>{b({page:1,perPage:10})},[]);const A=()=>{const s=C.getFieldsValue();k({current:1,pageSize:p.pageSize}),b({...s,page:1,perPage:p.pageSize})},G=()=>{C.resetFields(),k({current:1,pageSize:p.pageSize}),b({page:1,perPage:p.pageSize})},H=async s=>{if(E.length===0)try{const d=await re.fetchList({page:1,pageSize:100})}catch(d){console.error("加载角色列表失败:",d)}const t=s.role&&typeof s.role=="object"&&"id"in s.role?s.role.id:void 0;z.setFieldsValue({username:s.username,nickname:s.nickname,email:s.email,roleId:t}),N(s)},W=async()=>{try{const s=await z.validateFields();await m(s),z.resetFields()}catch{}};return e.jsxs(e.Fragment,{children:[e.jsxs(be,{children:[e.jsx(Ce,{children:e.jsxs(c,{form:C,layout:"inline",onFinish:A,style:{marginBottom:0},children:[e.jsx(c.Item,{name:"keyword",children:e.jsx(B,{placeholder:"用户名/昵称/邮箱",style:{width:200}})}),e.jsx(c.Item,{name:"status",children:e.jsxs(q,{placeholder:"选择状态",style:{width:120},allowClear:!0,children:[e.jsx(f,{value:"",children:"全部"}),e.jsx(f,{value:"active",children:"正常"}),e.jsx(f,{value:"inactive",children:"禁用"}),e.jsx(f,{value:"banned",children:"封禁"})]})}),e.jsx(c.Item,{name:"roleId",children:e.jsxs(q,{placeholder:"选择角色",style:{width:120},allowClear:!0,children:[e.jsx(f,{value:"",children:"全部"}),e.jsx(f,{value:1,children:"管理员"}),e.jsx(f,{value:2,children:"普通用户"}),e.jsx(f,{value:3,children:"访客"})]})}),e.jsx(c.Item,{name:"createdAt",children:e.jsx(Le,{placeholder:["开始时间","结束时间"],style:{width:240}})}),e.jsx(c.Item,{children:e.jsxs(te,{children:[e.jsx(O,{type:"primary",htmlType:"submit",icon:e.jsx(je,{}),children:"搜索"}),e.jsx(O,{onClick:G,children:"重置"})]})})]})}),e.jsx(ke,{children:e.jsxs(j,{dataSource:U,loading:D,rowKey:"id",pagination:{current:p.current,pageSize:p.pageSize,total:J,showSizeChanger:!g,showQuickJumper:!g,showTotal:(s,t)=>`第 ${t==null?void 0:t[0]}-${t==null?void 0:t[1]} 条/共 ${s} 条`,onChange:(s,t)=>{const d=C.getFieldsValue(),w=t||10;k({current:s,pageSize:w}),b({...d,page:s,perPage:w})}},...Ie({scrollX:1e3,scrollY:400,mobileScrollX:1e3,mobileScrollY:300,size:"middle",mobileSize:"small"},h),children:[e.jsx(j.Column,{title:"ID",dataIndex:"id",width:80}),e.jsx(j.Column,{title:"用户名",dataIndex:"username",width:120}),e.jsx(j.Column,{title:"昵称",dataIndex:"nickname",width:120,render:s=>s||"-"}),e.jsx(j.Column,{title:"邮箱",dataIndex:"email",width:200}),e.jsx(j.Column,{title:"状态",dataIndex:"statusText",width:100,render:(s,t)=>{const d=t.statusText||s||"-",v={正常:"green",禁用:"default",封禁:"red",启用:"green"}[d]||"default";return e.jsx(ae,{color:v,children:d})}}),e.jsx(j.Column,{title:"角色",dataIndex:"role",width:200,render:(s,t)=>{if(t.role&&typeof t.role=="object"&&"name"in t.role){const d=t.role.isDefaultText;return e.jsxs(te,{size:4,wrap:!0,children:[e.jsx(ae,{color:"blue",children:t.role.name}),d&&d.includes("默认角色")&&e.jsx(ae,{color:"gold",children:"默认"})]})}return e.jsx(fe.Text,{type:"secondary",children:"-"})}}),e.jsx(j.Column,{title:"创建时间",dataIndex:"createdAt",width:160,render:(s,t)=>t.createdAt?new Date(t.createdAt).toLocaleString("zh-CN"):"-"}),e.jsx(j.Column,{title:"操作",width:120,render:(s,t)=>e.jsxs(te,{size:"small",children:[e.jsx(le,{title:"编辑",children:e.jsx(O,{type:"link",icon:e.jsx(we,{}),onClick:()=>H(t)})}),e.jsx(le,{title:"重置密码",children:e.jsx(O,{type:"link",icon:e.jsx(Se,{}),onClick:()=>X(t)})}),e.jsx(le,{title:(()=>{const d=t.statusText||"";return(typeof t.status=="number"?t.status:t.status==="active"?1:0)===1||d.includes("正常")||d.includes("启用")?"禁用用户":"启用用户"})(),children:e.jsx(O,{type:"link",icon:e.jsx(ye,{}),onClick:()=>Q(t)})})]})})]})})]}),e.jsx(oe,{title:"编辑用户",open:V,onCancel:$,onOk:W,confirmLoading:D,width:600,children:e.jsxs(c,{form:z,layout:"vertical",children:[e.jsx(c.Item,{name:"username",label:"用户名",children:e.jsx(B,{placeholder:"用户名",disabled:!0})}),e.jsx(c.Item,{name:"nickname",label:"昵称",children:e.jsx(B,{placeholder:"昵称"})}),e.jsx(c.Item,{name:"email",label:"邮箱",rules:[{type:"email",message:"请输入有效的邮箱地址"}],children:e.jsx(B,{placeholder:"邮箱"})}),e.jsx(c.Item,{name:"roleId",label:"角色",rules:[{required:!0,message:"请选择角色"}],children:e.jsx(q,{placeholder:"请选择角色",children:F.map(s=>e.jsx(f,{value:s.value,children:s.label},s.value))})})]})}),e.jsxs(oe,{title:"重置密码",open:_,onCancel:K,onOk:()=>{M.validateFields().then(s=>{Y(s.password),M.resetFields()}).catch(()=>{})},confirmLoading:D,width:500,children:[P&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"用户："}),P.username]}),P.nickname&&e.jsxs("p",{children:[e.jsx("strong",{children:"昵称："}),P.nickname]})]}),e.jsx(c,{form:M,layout:"vertical",children:e.jsx(c.Item,{name:"password",label:"新密码",rules:[{required:!0,message:"请输入新密码"},{min:6,message:"密码长度至少6个字符"}],children:e.jsx(B.Password,{placeholder:"请输入新密码"})})})]})]})};export{Ee as default};
